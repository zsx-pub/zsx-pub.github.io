---
title: hexo部署到个人服务器linux
date: 2020-05-20 08:43:23
tags:
     - hexo
     - linux
---
---
**前言**
偶然在hkisl.net找到有免费vps，想着拿来试试搭梯子，结果搭完没几分钟端口就被墙，换了端口没多久又被墙(网上有[V2ray伪装流量](http://tlanyan.me/v2ray-traffic-mask/)的方法不知道效果会不会好一点),进而就想着把hexo部署到这来
PS:vps只能免费试用2天。。。！！！？？？我。。
---
<!-- more -->
# 1.了解hexo自动部署的架构
 在搞明白hexo的发布架构后，就会理解后边的操作内容
![](http://qa5rgbn80.bkt.clouddn.com/jiagou.png)
# 2.搭建流程
1. **服务器环境搭建**
	1.1 [安装git](#1.1)
	1.2 [Nginx配置](#1.2)
2. **自动化部署**
	2.1 [创建git用户](#2.1)
	2.2 [创建git裸库](#2.2)
	2.3 [hooks同步](#2.3)
3. **本地hexo配置**
	3.1 [ssh连接](#3.1)
	3.2 [deploy修改](#3.2)
# 3.服务器环境搭建
<h2 id="1.1">1. 安装git</h2>
远程登录服务器(SecureCRT,putty)
```
git --version //没有则安装
yum install git //安装
#安装NodeJS
curl --silent --location https://rpm.nodesource.com/setup_5.x | bash -
```
<h2 id="1.2">2. Nginx配置</h2>

1)安装: `yum install -y git nginx`
</br>2)修改配置文件`/etc/nginx/nginx.conf`，(用editplus远程登录后修改文件，不喜欢用vim)
```
server {

    listen 80;
        #listen [::]:80;
        server_name localhost;
        index index.html index.htm index.php default.html default.htm default.php;
        #这里要改成网站的根目录
        root  /home/git/blog/;

        #include other.conf;
        #error_page   404   /404.html;
        location ~ .*\.(ico|gif|jpg|jpeg|png|bmp|swf)$
        {
            access_log   off;
            expires      1d;
        }

        location ~ .*\.(js|css|txt|xml)?$
        {
            access_log   off;
            expires      12h;
        }

        location / {
            try_files $uri $uri/ =404;
        }

    }
```
3)刷新配置 `nginx -s reload`
>如果报错,参考:
```
nginx: [error] open() "/run/nginx.pid" failed (2: No such file or directory)

执行可解决：
/usr/sbin/nginx -c /etc/nginx/nginx.conf   #使用指定nginx.conf文件的方式重启nginx
```
4)启动nginx`nginx`

>如果报错，参考:
```
如果发现如下报错：
nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
nginx: [emerg] still could not bind()
说明80端口被占用，杀掉这个进程：

killall -9 nginx   //killa不能用，就kill PID
再次启动nginx

查看是否启动：
ps aux|grep nginx

root      2484  0.0  0.2 120832  2104 ?        Ss   18:04   0:00 nginx: master process nginx
root      2485  0.0  0.3 121228  3128 ?        S    18:04   0:00 nginx: worker process
root      2494  0.0  0.0 112676   980 pts/7    R+   18:08   0:00 grep --color=auto nginx

启动成功。
```
>启动还是错误，查看80端口是否打开
```
进入iptables配置80端口，因为nginx默认是由80端口访问
[root@localhost ~]# vim /etc/sysconfig/iptables
////如果没有 执行安装yum install iptables-services
这是配置信息：
# Generated by iptables-save v1.4.21 on Fri May 12 21:28:29 2017
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [6:696]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 21 -j ACCEPT（我给vsftpd配置的端口）
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT（给nginx配置的端口，原样输入就行了）
-A INPUT -p tcp -m state --state NEW -m tcp --dport 30000:30999 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT


///重启iptables，配置才生效
[root@localhost ~]# systemctl restart iptables.service

```

# 4.自动化部署
<h2 id="2.1">1. 创建git用户</h2>
```
adduser git      
sudo passwd git  #设置git用户的密码
```

<h2 id="2.2">2. 创建git裸库</h2>
```
su git
cd ~
mkdir -p blog
mkdir repos && cd repos
git init --bare blog.git
```

<h2 id="2.3">3. Hooks同步</h2>
使用的是 post-receive这个钩子，当git有收发的时候就会调用这个钩子。 在 ~/blog.git 裸库的 hooks文件夹中，新建post-receive文件
```
vim ./blog.git/hooks/post-receive

////文件内容如下:
#!/bin/sh
git --work-tree=/home/git/projects/blog --git-dir=/home/git/repos/blog.git checkout -f


////保存后修改权限
chmod +x ./blog.git/hooks/post-receive
cd ~
chown -R git:git /home/git/repos/blog.git/   #添加权限
```

# 5.hexo本地配置
<h2 id="3.1">1. ssh连接</h2>

在本地电脑操作 `ssh-copy-id -i ~/.ssh/id_rsa.pub git@SERVER`

>切换至git用户， 可以看到~/.ssh/authorized_keys 文件里已经有了本地电脑的公钥拷贝，这样就建立了ssh信任
```
su git
mkdir ~/.ssh
cat ~/.ssh/authorized_keys
```

回本地电脑,查看是否能免密登录
`ssh -v git@SEVER`
<h2 id="3.2">2. deploy修改</h2>
本地电脑hexo目录下_config.yml文件修改
```
deploy:
    type: git
    repo: git@SERVER:/home/git/blog.git    //<repository url>
    branch: master   
```
